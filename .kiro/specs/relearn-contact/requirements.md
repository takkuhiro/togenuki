# Requirements Document

## Introduction
登録済みの連絡先に「再学習」ボタンを新たに用意し、ユーザーがクリックすると、その時点までの最新メール履歴を使って学習パターン（`contact_context.learned_patterns`）を再生成する機能。既存の「再試行（retry）」は学習失敗時の復旧手段であるのに対し、「再学習」は学習完了済みの連絡先に対して最新情報で学習内容を更新する操作である。

## Requirements

### Requirement 1: 再学習ボタンの表示
**Objective:** ユーザーとして、学習完了済みの連絡先に対して再学習を実行できるボタンが表示されること。これにより、最新のメールパターンを反映した学習データに更新できる。

#### Acceptance Criteria
1. While 連絡先のステータスが「学習完了」である, the ContactCard shall 「再学習」ボタンを表示する
2. While 連絡先のステータスが「学習中」である, the ContactCard shall 「再学習」ボタンを非表示にする
3. While 連絡先のステータスが「学習失敗」である, the ContactCard shall 「再学習」ボタンを非表示にする（「再試行」ボタンのみ表示）

### Requirement 2: 再学習の実行
**Objective:** ユーザーとして、再学習ボタンをクリックすることで、その連絡先の学習データを最新メールに基づいて更新したい。これにより、時間経過に伴うコミュニケーションパターンの変化を返信生成に反映できる。

#### Acceptance Criteria
1. When ユーザーが「再学習」ボタンをクリックする, the システム shall 確認ダイアログを表示する
2. When ユーザーが確認ダイアログで「はい」を選択する, the システム shall 再学習APIを呼び出し、連絡先のステータスを「学習中」に変更する
3. When ユーザーが確認ダイアログで「キャンセル」を選択する, the システム shall 何も実行せずダイアログを閉じる
4. When 再学習APIが呼び出される, the バックエンド shall 既存の学習データを削除し、最新のメール履歴で学習処理をバックグラウンドで再実行する
5. When 再学習処理が完了する, the システム shall 連絡先のステータスを「学習完了」に更新し、新しい学習パターンを保存する

### Requirement 3: 再学習中のUI状態管理
**Objective:** ユーザーとして、再学習の進行状況がわかりやすく表示されること。これにより、処理の完了を待つ間も状況を把握できる。

#### Acceptance Criteria
1. While 再学習処理が実行中である, the ContactCard shall ステータスを「学習中」として表示し、再学習ボタンを無効化する
2. While 再学習処理が実行中である, the ContactList shall 既存のポーリング機能でステータスを定期的に更新する
3. When 再学習処理が完了しステータスが「学習完了」に戻る, the ContactCard shall 再学習ボタンを再度有効化する
4. When ユーザーが再学習処理中に画面遷移することもある, the バックエンド shall 学習処理を中断せず継続する
5. When ユーザーが連絡先ページに戻る, the ContactList shall ポーリングにより最新のステータスを反映する

### Requirement 4: 再学習のエラーハンドリング
**Objective:** ユーザーとして、再学習が失敗した場合に適切なフィードバックが得られること。これにより、問題の把握と再実行の判断ができる。

#### Acceptance Criteria
1. If 再学習処理が失敗する, the システム shall 連絡先のステータスを「学習失敗」に設定する
2. If 再学習APIの呼び出しがネットワークエラーで失敗する, the フロントエンド shall エラーメッセージを表示し、連絡先のステータスを変更しない
3. If 再学習中にOAuthトークンが無効である, the バックエンド shall トークンのリフレッシュを試み、リフレッシュにも失敗した場合は学習失敗として記録する

### Requirement 5: 再学習APIエンドポイント
**Objective:** バックエンドとして、再学習を実行するための専用APIエンドポイントを提供すること。これにより、フロントエンドから再学習をトリガーできる。

#### Acceptance Criteria
1. The バックエンド shall `POST /api/contacts/{contact_id}/relearn` エンドポイントを提供する
2. When 再学習リクエストを受信する, the バックエンド shall 連絡先の所有権を検証し、認可されたユーザーのみ実行を許可する
3. When 学習完了済みの連絡先に対して再学習リクエストを受信する, the バックエンド shall 即座に202 Acceptedを返却し、バックグラウンドで学習処理を開始する
4. If 学習中の連絡先に対して再学習リクエストを受信する, the バックエンド shall 409 Conflictを返却する
5. If 存在しない連絡先に対して再学習リクエストを受信する, the バックエンド shall 404 Not Foundを返却する

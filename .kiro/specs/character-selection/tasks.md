# Implementation Plan

- [x] 1. キャラクター定義サービスの実装
- [x] 1.1 キャラクター定義とサービスロジックの作成
  - 3つのキャラクター（全肯定ギャル、優しい先輩、冷静な執事）をimmutableな定義として作成する
  - 各キャラクターにID、表示名、説明文、LLMシステムプロンプト、TTS音声名を設定する
  - IDによるキャラクター取得機能を実装し、無効なIDまたはNullの場合はデフォルト（全肯定ギャル）にフォールバックする
  - 全キャラクター一覧の取得機能を実装する
  - 「優しい先輩」「冷静な執事」のシステムプロンプトを既存のギャルプロンプトと同等の粒度で設計する
  - TTS音声は暫定割り当て（ギャル=Callirrhoe, 先輩=Aoede, 執事=Charon）とし、実装時に確認する
  - _Requirements: 1.1, 1.2, 1.3, 3.2, 4.3_

- [x] 2. (P) データベーススキーマ変更
  - ユーザーテーブルにキャラクター選択カラムを追加するマイグレーションを作成する
  - NULL許容とし、NULLの場合はデフォルトキャラクター（全肯定ギャル）として扱う
  - ORMモデルに対応するフィールドを追加する
  - _Requirements: 3.1, 3.2_

> **開発者アクション（タスク2完了後）**:
> - Cloud SQL に接続し、Alembicマイグレーションを実行する: `cd apps/api && alembic upgrade head`
> - マイグレーション適用後、`users`テーブルに`selected_character_id`カラムが追加されていることを確認する

- [ ] 3. (P) GeminiServiceの汎用化
- [ ] 3.1 メール変換メソッドのパラメータ化
  - 既存のギャル専用変換メソッドを、システムプロンプトを外部から受け取る汎用メソッドにリファクタリングする
  - 既存のギャル用システムプロンプト定数をキャラクター定義側に移動する
  - ビジネスメール清書メソッドとパターン分析メソッドは変更しない
  - 既存テストを新しいメソッドシグネチャに合わせて修正する
  - _Requirements: 4.1_

- [ ] 4. (P) TTSServiceの音声切替対応
- [ ] 4.1 音声合成メソッドの音声名パラメータ化
  - 音声合成メソッドにオプションの音声名パラメータを追加する
  - 音声名が未指定の場合は従来通り設定値をフォールバックとして使用する
  - 既存テストを新しいメソッドシグネチャに合わせて修正する
  - _Requirements: 4.2_

- [ ] 5. キャラクターAPIエンドポイント
- [ ] 5.1 (P) キャラクター一覧取得APIの実装
  - 全キャラクターのID・表示名・説明文を返却するエンドポイントを作成する
  - 認証なしでアクセス可能にする（公開情報）
  - レスポンススキーマを定義する
  - アプリケーションにルーターを登録する
  - _Requirements: 2.1, 2.2_

- [ ] 5.2 (P) ユーザーキャラクター選択・取得APIの実装
  - ユーザーの選択キャラクターを更新するエンドポイントを作成する（認証必須）
  - ユーザーの現在の選択キャラクターを取得するエンドポイントを作成する（認証必須）
  - 無効なキャラクターIDの場合は400エラーを返却する
  - リクエスト・レスポンススキーマを定義する
  - _Requirements: 3.1_

> **開発者アクション（タスク5完了後）**:
> - バックエンド開発サーバーを起動し、APIの動作確認を行う: `cd apps/api && uvicorn src.main:app --reload`
> - `curl http://localhost:8000/api/characters` でキャラクター一覧が返却されることを確認する
> - 認証トークンを使って `PUT /api/users/character` と `GET /api/users/character` の動作を確認する

- [ ] 6. メール処理パイプラインの統合
- [ ] 6.1 キャラクター対応のメール変換パイプライン
  - メール処理時にユーザーの選択キャラクターIDを取得する
  - キャラクター定義サービスからシステムプロンプトとTTS音声名を取得する
  - 汎用化されたGeminiServiceメソッドにキャラクターのシステムプロンプトを渡す
  - TTSServiceにキャラクターのTTS音声名を渡す
  - 既存のモック対象を新しいメソッド名に更新する（integration test含む）
  - _Requirements: 3.3, 3.4, 4.1, 4.2, 4.3_

> **開発者アクション（タスク6完了後）**:
> - 登録済み連絡先からテストメールを送信し、選択中のキャラクターで変換・音声生成が行われることを確認する
> - キャラクターを変更してから再度テストメールを送信し、新しいキャラクターの口調・音声で処理されることを確認する
> - 変更前に処理済みのメールが影響を受けていないことをダッシュボードで確認する

- [ ] 7. フロントエンド キャラクター選択UI
- [ ] 7.1 API呼び出しモジュールの作成
  - キャラクター一覧取得、現在の選択取得、選択更新のAPI呼び出し関数を作成する
  - リクエスト・レスポンスの型定義を作成する
  - _Requirements: 2.1, 3.1_

- [ ] 7.2 キャラクター選択コンポーネントと設定画面への統合
  - キャラクター選択コンポーネントを作成し、カード形式で3キャラクターを表示する
  - 選択中のキャラクターを視覚的にハイライトする
  - カード選択時に即座にAPIへ保存リクエストを送信する
  - 保存中はローディング状態を表示し、完了後に確定表示を更新する
  - 初回レンダリング時にキャラクター一覧と現在の選択を取得する
  - 連絡先管理画面にキャラクター選択セクションを追加する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

> **開発者アクション（タスク7完了後）**:
> - フロントエンド開発サーバーを起動: `cd apps/web && npm run dev`
> - ブラウザで設定画面（/contacts）を開き、キャラクター選択セクションが表示されることを確認する
> - 3つのキャラクターカードが表示され、選択・切替・保存が正常に動作することを確認する
> - ページリロード後も選択が保持されることを確認する

- [ ] 8. 統合テスト
- [ ] 8.1 キャラクター選択からメール変換までのE2Eフロー検証
  - デフォルトキャラクター（NULLのユーザー）でギャルが適用されることを検証する
  - キャラクター変更後に新しいキャラクターで新規メールが処理されることを検証する
  - 処理済みメールがキャラクター変更の影響を受けないことを検証する
  - 無効なキャラクターID時のフォールバック動作を検証する
  - _Requirements: 3.2, 3.3, 3.4, 4.1, 4.2, 4.3_

> **開発者アクション（タスク8完了後・全体完了時）**:
> - 全テストを実行して通過を確認: `cd apps/api && pytest` / `cd apps/web && npm run test:run`
> - lint・formatチェック: `cd apps/api && ruff check src/` / `cd apps/web && npm run check`
> - 本番環境へのデプロイ: `cd apps/api && bash deploy.sh`（Terraformの変更は不要）

> **並列実行ガイド**: タスク1を先に完了した後、タスク2(P)・3(P)・4(P)は並列実行可能。タスク5.1(P)と5.2(P)はそれぞれタスク1と2の完了後に並列実行可能。タスク6はタスク1-4全ての完了が前提。タスク7はタスク5の完了が前提。タスク8は全タスクの完了が前提。
